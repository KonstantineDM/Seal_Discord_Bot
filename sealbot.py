import discord
from discord.ext import commands
import youtube_dl
import os
from dotenv import load_dotenv

intents = discord.Intents.default()

#TODO: check installed site-packages - are all of them needed?

# Take environment variables from .env file
load_dotenv()

# Discord Token
DISCORD_TOKEN = os.getenv("DISCORD_TOKEN")

# make a Client and a Bot instances
client = discord.Client(intents=intents)
bot = commands.Bot(command_prefix='~', intents=intents)

@client.event
async def on_message(message):
    message.content = message.content.lower()
    if message.author == client.user:
        return
    if message.content.startswith(("–ø—Ä–∏–≤–µ—Ç", "–∫—É", "hello", "hi", "hey")):
        await message.channel.send(f"*–ì–∞–≤–∫–∞–µ—Ç –ø–æ-—Ç—é–ª–µ–Ω—å–∏* (–ü—Ä–∏–≤–µ—Ç, {message.author}!)")
        with open(r'.\assets\hello\hey1.gif', 'rb') as file:
            hello_picture = discord.File(file)
            await message.channel.send(file=hello_picture)

# TODO: check if this function works
@bot.event
async def on_member_join(member):
        with open(r'.\assets\hello\hey-gif.gif', 'rb') as file:
            hello_picture = discord.File(file)
            await message.channel.send(file=hello_picture)

@bot.command()
async def play(context, url:str, channel="–û—Å–Ω–æ–≤–Ω–æ–π"):
    music_check = os.path.isfile("music.mp3")
    try:
        if music_check: os.remove("music.mp3")
    except PermissionError:
        await context.send(f"–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä–∞—é—â–µ–π –º—É–∑—ã–∫–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ"
                           " –∫–æ–º–∞–Ω–¥—É {bot.command_prefix}stop")
        # return

    voice_channel = discord.utils.get(context.guild.voice_channels,
                                      name=channel)
    try: await voice_channel.connect()
    except: await context.send("–ë–æ—Ç —É–∂–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–ª—Å—è –∫ –∫–∞–Ω–∞–ª—É")
    voice_client = discord.utils.get(client.voice_clients, guild=context.guild)
    # else: voice_client.move_to(channel)

    ydl_options = {
        "format": "bestaudio/best",
        "postprocessor": [{
            "key": "FFmpegExtractAudio",
            "preferredcodec": "mp3",
            "preferredquality": "192",
        }]
    }
    with youtube_dl.YoutubeDL(ydl_options) as ytdl:
        ytdl.download([url])

    for file in os.listdir(".\\"):
        if file.endswith((".m4a", ".webm")):
            os.rename(file, "music.mp3")

    context.message.guild.voice_client.play(
        discord.FFmpegPCMAudio(executable="ffmpeg.exe",
                               source=".\music.mp3"))
    # voice_client.play(discord.FFmpegPCMAudio(executable="ffmpeg.exe",
    #                                          source="music.mp3"))

@bot.command()
async def leave(context):
    voice_client = discord.utils.get(client.voice_clients, guild=context.guild)
    if voice_client.connected(): await voice_channel.dicconnect()
    else: context.send("–Ø –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —ç—Ç–æ–º—É –∫–∞–Ω–∞–ª—É")

@bot.command()
async def pause(context):
    voice_client = discord.utils.get(client.voice_clients, guild=context.guild)
    if voice_client.is_playing(): voice_client.pause()
    else: context.send("–°–µ–π—á–∞—Å –Ω–∏—á–µ–≥–æ –Ω–µ –∏–≥—Ä–∞–µ—Ç")

@bot.command()
async def resume(context):
    voice_client = discord.utils.get(client.voice_clients, guild=context.guild)
    if voice_client.is_paused(): voice.resume()
    else: context.send("–ú—É–∑—ã–∫–∞ –Ω–µ —Å—Ç–æ–∏—Ç –Ω–∞ –ø–∞—É–∑–µ")

@bot.command()
async def stop(context):
    voice_client = discord.utils.get(client.voice_clients, guild=context.guild)
    if voice_client.is_playing(): voice_client.stop()
    else: context.send("–°–µ–π—á–∞—Å –Ω–∏—á–µ–≥–æ –Ω–µ –∏–≥—Ä–∞–µ—Ç")

# üé∂

if __name__ == '__main__':
    # run a Client
    bot.run(DISCORD_TOKEN)
    client.run(DISCORD_TOKEN)
